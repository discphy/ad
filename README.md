# 광고 API 

## 🛠️ 설계

### 설계 문서 작성

+ 요구사항을 뾰족하게 분석하고, 기능적 요구사항과 비기능적 요구사항을 구분하여 [요구사항 분석 문서](docs/design/01-requirements.md)를 작성
+ 버드뷰 시점으로 도메인 및 서비스를 기준으로 [시퀀스 다이어그램](docs/design/02-sequence-diagrams.md)을 작성
+ 도메인 모델을 기준으로 [클래스 다이어그램](docs/design/03-class-diagrams.md)을 작성
+ 클래스 다이어그램을 기반으로 [ERD](docs/design/04-erd.md)를 작성
+ 문서화를 작성하면서 도메인과 비지니스 로직에 대한 이해도를 높임

### 기술 스택

+ Java, Spring Boot, JPA, MySQL, Docker

### 프로젝트 아키텍처

+ 레이어드 아키텍처와 클린 아키텍처의 장점을 조합한 클린 레이어드 아키텍처 적용
+ 도메인 레이어를 가장 중심에 두고, 인터페이스 레이어와 인프라 레이어를 분리하여 DIP, OCP 원칙을 준수하여 객체 지향 설계
+ 도메인 서비스는 높은 응집도와 낮은 결합도를 유지하여 변경에 유연하게 대응할 수 있도록 설계
+ 파사드 패턴을 적용하여 도메인 서비스를 조합하여 비지니스 로직 구성
+ 해당 아키텍처를 적용하면서 확장성, 유지보수성, 테스트 용이성을 고려하여 설계

## 💡 핵심 문제해결

+ 🔗 PR 링크 : https://github.com/discphy/ad/pull/1

### 도메인 중심 설계

+ 데이터 중심이 아닌 도메인 중심의 설계를 통해 비지니스 로직을 명확하게 정의
+ 광고 참여 기능에서, 외부 API 호출을 통한 포인트 적립은 이벤트 기반으로 작성하여 비지니스 로직과 외부 시스템의 의존성을 최소화
+ 도메인 이벤트를 활용하여 광고 참여와 포인트 적립 간의 결합도를 낮추고, 핵심 로직과 분리하면서 확장성을 고려한 설계

### 테스트 코드 작성 

+ TDD 방식으로 개발을 진행하여, 실패하는 테스트 케이스에 집중하여 안정성 높은 코드를 작성하고자 하였습니다.
+ Unit, Integration, E2E 테스트를 작성하여 각 레이어의 동작을 검증하고, 전체 시스템의 통합 동작을 확인하였습니다.
+ Unit 테스트에서는 Mock 객체를 활용하여 의존성을 분리하고 독립적인 테스트를 작성하였습니다. 
+ Integration 테스트에서는 실제 데이터베이스와의 연동을 통해 데이터의 일관성을 검증하였습니다.
+ E2E 테스트에서는 전체 시스템의 흐름을 검증하여 요구사항에 부합하는 기능이 정상적으로 동작하는지 확인하였습니다.

### 성능 최적화

+ 주요 쿼리에 대한 인덱스를 설정하여 데이터 조회 성능을 향상
+ 광고 이력 조회 시, 페이징 쿼리를 커서 기반 페이징을 적용하거나 유저 별로 MV(Materialized View)를 구성하여 읽기 성능을 최적화 할 수 있다.
+ 읽기 작업에서 대용량 트래픽을 고려한 MV(Materialized View) 설계 및 로컬, 글로벌 캐시를 활용하여 데이터 조회 성능을 최적화할 수 있다. 
+ 또한 쓰기 작업에서 동시성 제어를 DB 락이 아닌 Redis 자료구조 혹은 Kafka를 활용하여 DB 쓰기 부하를 분산시켜 성능을 향상시킬 수 있다.

### 동시성 이슈 제어

+ 여러 사용자가 동시에 광고 참여 시, "광고 참여 횟수" 자원에 동시에 접근하고 차감할 때 동시성 이슈 가능성
+ 이를 해결하기 위해, 비관적 락(Pessimistic Lock)을 사용하여 동시성 제어

### 확장성을 고려한 전략 패턴 설계

+ 광고 참가 자격 조건이 변경되거나 추가될 경우, 기존 코드를 수정하지 않고 새로운 조건을 추가할 수 있도록 전략 패턴을 적용
+ 광고 자격 조건을 인터페이스로 정의하고, 각 조건을 구현한 클래스를 생성하여 확장성을 고려한 설계
+ RDB에서는 광고 자격 타입을 Enum으로 정의하고, 광고 자격 조건이 여러가지 케이스가 나올 수 있어 JSON 형태로 저장
+ JSON을 직렬화, 역직렬화하여 다양한 광고 자격 조건을 유연하게 처리할 수 있도록 설계

## ✅ 한계

### 외부 API 호출 및 데이터 정합성 문제

+ 외부 API 호출을 통한 포인트 적립은 이벤트 기반 비동기로 처리하여 실패할 경우 데이터 정합성 문제 발생 가능성이 있어 광고 이력 정보랑 동기화하는 로직이 필요할 수 있다. 
+ 안정성있는 API 호출을 위해 Resilience4j와 같은 라이브러리를 활용하여 재시도, 회로 차단 등의 패턴을 적용할 수 있다.

### 대용량 트래픽에서의 RDB 한계

+ 대용량 트래픽을 처리하기 위해 RDB의 한계로 읽기, 쓰기 작업에서 성능 저하가 발생할 수 있다.
+ 이를 해결하기 위해 Caffeine과 같은 로컬 캐시를 활용하거나, Redis와 같은 글로벌 캐시를 활용하여 데이터 조회 성능을 향상시킬 수 있다.
+ 또한, 쓰기 작업에서는 현재 RDB 비관적 락을 사용하고 있어 대기 시간이 발생하여 성능 저하가 발생할 수 있다.
+ 이를 해결하기 위해 Redis 자료구조를 활용하여 DB 락이 없는 설계로 변경하거나, Kafka를 활용하여 광고 ID를 파티션 키로 설정하여 병렬 처리를 통해 성능을 향상시킬 수 있다.
